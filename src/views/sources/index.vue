<template>
  <div class="min-h-screen bg-gray-50 p-6">
    <!-- Header Section -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6 p-6">
      <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
      >
        <div class="flex items-center gap-3">
          <div
            class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
          >
            <i class="pi pi-globe text-blue-600 text-xl"></i>
          </div>
          <div>
            <h1 class="text-2xl font-semibold text-gray-900">
              Lista de Fontes de Notícias
            </h1>
            <p class="text-gray-600">
              Gerencie e visualize todas as fontes de notícias cadastradas
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
      <!-- Header -->
      <div class="p-6 border-b border-gray-200">
        <div
          class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4"
        >
          <div class="flex items-center gap-3">
            <i class="pi pi-newspaper text-blue-600 text-xl"></i>
            <h2 class="text-xl font-semibold text-gray-900">Todas as Fontes</h2>
          </div>
          <div class="relative">
            <i
              class="pi pi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
            ></i>
            <input
              v-model="searchTerm"
              type="text"
              placeholder="Buscar fontes..."
              class="pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 w-full lg:w-80 transition-colors duration-200 text-gray-900 placeholder-gray-500"
              @input="onSearchInput"
            />
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="p-6">
        <!-- Loading State -->
        <div
          v-if="loading"
          class="flex flex-col items-center justify-center py-12"
        >
          <div
            class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"
          ></div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">
            Carregando fontes...
          </h3>
          <p class="text-gray-600">Aguarde enquanto buscamos suas fontes</p>
        </div>

        <!-- Content -->
        <div v-else>
          <!-- Stats Bar -->
          <div
            class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6 pb-6 border-b border-gray-200"
          >
            <div class="flex items-center gap-4 text-sm text-gray-600">
              <div class="flex items-center gap-2">
                <i class="pi pi-filter"></i>
                <span>
                  Mostrando
                  <strong class="text-gray-900">{{ currentItemsCount }}</strong>
                  de <strong class="text-gray-900">{{ totalItems }}</strong>
                  fonte(s)
                  <span v-if="searchTerm" class="text-gray-500">
                    (filtro: "{{ searchTerm }}")
                  </span>
                </span>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div class="flex items-center gap-2 text-sm text-gray-600">
                <i class="pi pi-database"></i>
                <span
                  >Total:
                  <strong class="text-gray-900">{{ totalItems }}</strong>
                  fonte(s)</span
                >
              </div>
              <div
                v-if="searchTerm"
                class="flex items-center gap-2 bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm"
              >
                <i class="pi pi-filter"></i>
                <span>{{ searchTerm }}</span>
                <button @click="clearSearch" class="hover:text-blue-900">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Table -->
          <div class="overflow-hidden rounded-lg border border-gray-200 mb-6">
            <!-- Table Header -->
            <div
              class="bg-gray-50 grid grid-cols-12 gap-4 px-6 py-3 border-b border-gray-200"
            >
              <div
                class="col-span-1 font-medium text-gray-900 text-sm text-center"
              >
                <i class="pi pi-hashtag text-gray-500"></i>
              </div>
              <div class="col-span-3 font-medium text-gray-900 text-sm">
                <div class="flex items-center gap-2">
                  <i class="pi pi-building text-gray-500"></i>
                  Nome da Fonte
                </div>
              </div>
              <div class="col-span-4 font-medium text-gray-900 text-sm">
                <div class="flex items-center gap-2">
                  <i class="pi pi-link text-gray-500"></i>
                  URL
                </div>
              </div>
              <div class="col-span-2 font-medium text-gray-900 text-sm">
                <div class="flex items-center gap-2">
                  <i class="pi pi-circle-fill text-gray-500 text-xs"></i>
                  Status
                </div>
              </div>
              <div
                class="col-span-2 font-medium text-gray-900 text-sm text-center"
              >
                Ações
              </div>
            </div>

            <!-- Table Body -->
            <div v-if="displayedSources.length > 0">
              <div
                v-for="(source, index) in displayedSources"
                :key="source.id"
                :class="[
                  'grid grid-cols-12 gap-4 px-6 py-4 border-b border-gray-200 transition-colors duration-200',
                  index % 2 === 0 ? 'bg-white' : 'bg-gray-50',
                  'hover:bg-blue-50',
                ]"
              >
                <!-- ID -->
                <div class="col-span-1">
                  <div class="flex justify-center">
                    <span
                      class="inline-block bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-mono font-bold"
                    >
                      {{ source.id }}
                    </span>
                  </div>
                </div>

                <!-- Nome da Fonte -->
                <div class="col-span-3">
                  <div class="flex items-center gap-3">
                    <div
                      :class="[
                        'w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0',
                        getSourceColorClass(source.name),
                      ]"
                    >
                      <i
                        :class="getSourceIcon(source.name)"
                        class="text-white text-sm"
                      ></i>
                    </div>
                    <div class="min-w-0 flex-1">
                      <span class="font-semibold text-gray-900 block">
                        {{ source.name }}
                      </span>
                      <span class="text-xs text-gray-500 mt-1 block">
                        {{ getSourceType(source.name) }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- URL -->
                <div class="col-span-4">
                  <div class="flex items-center gap-2">
                    <a
                      :href="source.href"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-blue-600 hover:text-blue-800 hover:underline transition-colors duration-200 text-sm truncate flex items-center gap-1"
                      :title="source.href"
                    >
                      <i class="pi pi-external-link text-xs"></i>
                      {{ formatUrl(source.href) }}
                    </a>
                    <span
                      :class="[
                        'px-2 py-1 rounded text-xs font-medium',
                        getDomainTypeClass(source.href),
                      ]"
                    >
                      {{ getDomainType(source.href) }}
                    </span>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    {{ getDomainInfo(source.href) }}
                  </div>
                </div>

                <!-- Status -->
                <div class="col-span-2">
                  <div class="flex flex-col gap-1">
                    <span
                      :class="[
                        'px-3 py-1.5 rounded-full text-sm font-medium flex items-center gap-1.5 w-fit',
                        getStatusClass(source),
                      ]"
                    >
                      <i :class="getStatusIcon(source)" class="text-xs"></i>
                      {{ getStatusText(source) }}
                    </span>
                    <span class="text-xs text-gray-500">
                      {{ getLastUpdate(source) }}
                    </span>
                  </div>
                </div>

                <!-- Actions -->
                <div class="col-span-2">
                  <div class="flex justify-center gap-1">
                    <button
                      @click="openWebsite(source.href)"
                      class="w-9 h-9 flex items-center justify-center text-blue-500 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-all duration-200 border border-blue-200 hover:border-blue-300"
                      title="Abrir site"
                    >
                      <i class="pi pi-external-link text-sm"></i>
                    </button>
                    <button
                      @click="testConnection(source)"
                      class="w-9 h-9 flex items-center justify-center text-green-500 hover:text-green-700 hover:bg-green-50 rounded-lg transition-all duration-200 border border-green-200 hover:border-green-300"
                      title="Testar conexão"
                    >
                      <i class="pi pi-wifi text-sm"></i>
                    </button>
                    <button
                      @click="viewStats(source)"
                      class="w-9 h-9 flex items-center justify-center text-purple-500 hover:text-purple-700 hover:bg-purple-50 rounded-lg transition-all duration-200 border border-purple-200 hover:border-purple-300"
                      title="Ver estatísticas"
                    >
                      <i class="pi pi-chart-bar text-sm"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Empty State -->
            <div v-else class="text-center py-12">
              <div class="flex flex-col items-center gap-4">
                <i class="pi pi-search text-gray-300 text-6xl"></i>
                <div>
                  <h3 class="text-lg font-medium text-gray-900 mb-2">
                    Nenhuma fonte encontrada
                  </h3>
                  <p v-if="searchTerm" class="text-gray-600">
                    Tente ajustar os termos da busca: "{{ searchTerm }}"
                  </p>
                  <p v-else class="text-gray-600">
                    Nenhuma fonte cadastrada no sistema
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- PAGINAÇÃO SEMPRE VISÍVEL QUANDO HÁ DADOS -->
          <div
            v-if="totalItems > 0"
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pt-6 border-t border-gray-200"
          >
            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
              <!-- Informações da página -->
              <div class="flex items-center gap-2 text-sm text-gray-600">
                <i class="pi pi-file"></i>
                <span>
                  Página {{ currentPage }} de {{ totalPages }} - Mostrando
                  {{ currentItemsCount }} de {{ totalItems }} registros
                </span>
              </div>

              <!-- Seletor de Itens por Página -->
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-600">Itens por página:</span>
                <select
                  v-model="pageSize"
                  @change="onPageSizeChange"
                  class="text-black border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-colors duration-200"
                >
                  <option
                    v-for="size in pageSizeOptions"
                    :key="size"
                    :value="size"
                  >
                    {{ size }}
                  </option>
                </select>
              </div>
            </div>

            <!-- CONTROLES DE PAGINAÇÃO -->
            <div v-if="totalPages > 1" class="flex items-center gap-2">
              <!-- Botão Anterior -->
              <button
                @click="goToPage(currentPage - 1)"
                :disabled="currentPage <= 1"
                :class="[
                  'flex items-center gap-2 px-4 py-2 border rounded-lg transition-colors duration-200 font-medium',
                  currentPage <= 1
                    ? 'border-gray-300 text-gray-400 cursor-not-allowed'
                    : 'border-gray-300 text-gray-700 hover:bg-gray-50',
                ]"
              >
                <i class="pi pi-chevron-left"></i>
                <span class="hidden sm:block">Anterior</span>
              </button>

              <!-- Números das Páginas -->
              <div class="flex gap-1">
                <button
                  v-for="page in visiblePages"
                  :key="page"
                  @click="goToPage(page)"
                  :class="[
                    'w-10 h-10 flex items-center justify-center border rounded-lg transition-colors duration-200 font-medium',
                    page === currentPage
                      ? 'bg-blue-600 text-white border-blue-600'
                      : 'border-gray-300 text-gray-700 hover:bg-gray-50',
                  ]"
                >
                  {{ page }}
                </button>
                <span
                  v-if="showEllipsis"
                  class="w-10 h-10 flex items-center justify-center text-gray-500"
                >
                  ...
                </span>
              </div>

              <!-- Botão Próximo -->
              <button
                @click="goToPage(currentPage + 1)"
                :disabled="currentPage >= totalPages"
                :class="[
                  'flex items-center gap-2 px-4 py-2 border rounded-lg transition-colors duration-200 font-medium',
                  currentPage >= totalPages
                    ? 'border-gray-300 text-gray-400 cursor-not-allowed'
                    : 'border-gray-300 text-gray-700 hover:bg-gray-50',
                ]"
              >
                <span class="hidden sm:block">Próxima</span>
                <i class="pi pi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from "vue";
// import { useToast } from "primevue/usetoast";
import axios from "axios";

// const toast = useToast();
const sources = ref([]);
const searchTerm = ref("");
const loading = ref(false);

const currentPage = ref(1);
const pageSize = ref(10);
const totalItems = ref(0);
const totalPages = ref(1);

// Opções para o seletor de itens por página
const pageSizeOptions = [5, 10, 15, 20, 25];

// Computed para páginas visíveis (com ellipsis para muitas páginas)
const visiblePages = computed(() => {
  const pages = [];
  const maxVisible = 5;

  let start = Math.max(1, currentPage.value - Math.floor(maxVisible / 2));
  let end = Math.min(totalPages.value, start + maxVisible - 1);

  // Ajustar start se end estiver no limite
  if (end - start + 1 < maxVisible) {
    start = Math.max(1, end - maxVisible + 1);
  }

  for (let i = start; i <= end; i++) {
    pages.push(i);
  }

  return pages;
});

// Computed para mostrar reticências
const showEllipsis = computed(() => {
  return totalPages.value > 5 && currentPage.value < totalPages.value - 2;
});

// Computed para sources que devem ser exibidas
const displayedSources = computed(() => {
  if (searchTerm.value) {
    // Quando há busca, faz filtro local nos dados já carregados
    const term = searchTerm.value.toLowerCase();
    return sources.value.filter(
      (source) =>
        source.name?.toLowerCase().includes(term) ||
        source.href?.toLowerCase().includes(term)
    );
  } else {
    // Sem busca, usa os dados da API já paginados
    return sources.value;
  }
});

// Computed para contar itens atuais
const currentItemsCount = computed(() => {
  if (searchTerm.value) {
    return displayedSources.value.length;
  } else {
    return sources.value.length;
  }
});

// Funções para cores e estilos
const getSourceColorClass = (sourceName) => {
  const colors = {
    G1: "bg-red-500",
    metrópoles: "bg-purple-500",
    Folha: "bg-orange-500",
    CNN: "bg-red-600",
    Estadão: "bg-blue-500",
    "Seles Nafes": "bg-green-500",
  };
  return colors[sourceName] || "bg-gray-500";
};

const getSourceIcon = (sourceName) => {
  const icons = {
    G1: "pi pi-globe",
    metrópoles: "pi pi-building",
    Folha: "pi pi-file",
    CNN: "pi pi-video",
    Estadão: "pi pi-flag",
    "Seles Nafes": "pi pi-star",
  };
  return icons[sourceName] || "pi pi-question-circle";
};

const getSourceType = (sourceName) => {
  const types = {
    G1: "Portal de Notícias",
    metrópoles: "Jornal Digital",
    Folha: "Jornal",
    CNN: "Canal de Notícias",
    Estadão: "Jornal",
    "Seles Nafes": "Site Especializado",
  };
  return types[sourceName] || "Fonte de Notícias";
};

const getDomainType = (url) => {
  if (!url) return "Site";
  if (url.includes(".com.br")) return ".com.br";
  if (url.includes(".com")) return ".com";
  if (url.includes(".org")) return ".org";
  if (url.includes(".net")) return ".net";
  return "Site";
};

const getDomainTypeClass = (url) => {
  const type = getDomainType(url);
  const classes = {
    ".com.br": "bg-blue-100 text-blue-800",
    ".com": "bg-green-100 text-green-800",
    ".org": "bg-purple-100 text-purple-800",
    ".net": "bg-orange-100 text-orange-800",
    Site: "bg-gray-100 text-gray-800",
  };
  return classes[type] || "bg-gray-100 text-gray-800";
};

const getDomainInfo = (url) => {
  try {
    const urlObj = new URL(url);
    return `${urlObj.hostname.replace("www.", "")}`;
  } catch {
    return "URL inválida";
  }
};

const getStatusClass = (source) => {
  // Simulação de status baseado no ID (para demonstração)
  const status = source.id % 3;
  const classes = {
    0: "bg-green-50 text-green-700 border border-green-200",
    1: "bg-yellow-50 text-yellow-700 border border-yellow-200",
    2: "bg-blue-50 text-blue-700 border border-blue-200",
  };
  return (
    classes[status] || "bg-green-50 text-green-700 border border-green-200"
  );
};

const getStatusIcon = (source) => {
  const status = source.id % 3;
  const icons = {
    0: "pi pi-check-circle",
    1: "pi pi-clock",
    2: "pi pi-sync",
  };
  return icons[status] || "pi pi-check-circle";
};

const getStatusText = (source) => {
  const status = source.id % 3;
  const texts = {
    0: "Ativa",
    1: "Pendente",
    2: "Sincronizando",
  };
  return texts[status] || "Ativa";
};

const getLastUpdate = (source) => {
  // Data mockada baseada no ID
  const daysAgo = (source.id % 7) + 1;
  return `Atualizado há ${daysAgo} dia${daysAgo > 1 ? "s" : ""}`;
};

// Handler para input de busca com debounce
let searchTimeout = null;
const onSearchInput = () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    if (searchTerm.value) {
      // Com busca, usa filtro local - não precisa recarregar da API
      currentPage.value = 1;
    } else {
      // Sem busca, recarrega a página 1 da API
      currentPage.value = 1;
      loadSources();
    }
  }, 500);
};

// Handler para mudança no número de itens por página
const onPageSizeChange = () => {
  currentPage.value = 1; // Volta para a primeira página
  loadSources();
};

const loadSources = async () => {
  loading.value = true;
  try {
    const response = await axios.get(
      "http://10.25.115.57:8000/ingest/sources",
      {
        params: {
          page: currentPage.value,
          limit: pageSize.value,
        },
      }
    );

    // Usa a estrutura correta da API: result, page, limit, total_items, total_pages
    sources.value = response.data.result || [];
    totalItems.value = response.data.total_items || 0;
    totalPages.value = response.data.total_pages || 1;
    currentPage.value = response.data.page || 1;
    pageSize.value = response.data.limit || 10;

    console.log("📊 Dados das fontes da API:", {
      currentPage: currentPage.value,
      totalPages: totalPages.value,
      totalItems: totalItems.value,
      pageSize: pageSize.value,
      itemsCount: sources.value.length,
    });
  } catch (error) {
    console.error("Erro ao carregar fontes:", error);
    // toast.add({
    //   severity: "error",
    //   summary: "Erro",
    //   detail: "Não foi possível carregar as fontes",
    //   life: 5000,
    // });
    sources.value = [];
    totalItems.value = 0;
    totalPages.value = 1;
    currentPage.value = 1;
  } finally {
    loading.value = false;
  }
};

const goToPage = (page) => {
  if (page >= 1 && page <= totalPages.value && !searchTerm.value) {
    currentPage.value = page;
    loadSources();
  }
};

const clearSearch = () => {
  searchTerm.value = "";
  currentPage.value = 1;
  loadSources();
};

const formatUrl = (url) => {
  if (!url) return "";
  try {
    const urlObj = new URL(url);
    return urlObj.hostname + (urlObj.pathname !== "/" ? urlObj.pathname : "");
  } catch {
    return url.length > 50 ? url.substring(0, 50) + "..." : url;
  }
};

const openWebsite = (url) => {
  window.open(url, "_blank", "noopener,noreferrer");
};

const testConnection = (source) => {
  // toast.add({
  //   severity: "info",
  //   summary: "Teste de Conexão",
  //   detail: `Testando conexão com: ${source.name}`,
  //   life: 3000,
  // });
};

const viewStats = (source) => {
  // toast.add({
  //   severity: "info",
  //   summary: "Estatísticas",
  //   detail: `Abrindo estatísticas de: ${source.name}`,
  //   life: 3000,
  // });
};

onMounted(() => {
  loadSources();
});
</script>

<style scoped>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
